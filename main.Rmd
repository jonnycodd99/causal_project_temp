
```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(kableExtra)
library(Hmisc)

opts_chunk$set(fig.align="center",
               comment="",
               collapse=TRUE)
```


```{r}
data <- read.csv('nhefs_complete.csv')
columns_metadata <- read.csv('nhefs_codebook.csv') 
print(head(data, 5))
```

hist(dat$wt82_71)


## Propensity score (chapter 15)

```{r}
model.propensity <- glm(qsmk ~ sex + race + age + I(age*age) + as.factor(education)
            + smokeintensity + I(smokeintensity*smokeintensity) + smokeyrs
            + I(smokeyrs*smokeyrs) + as.factor(exercise) + as.factor(active)
            + wt71 + I(wt71*wt71), data=data, family=binomial())
# simple version
model.propensity <- glm(qsmk ~ sex + age + I(age*age) + as.factor(education)
            + smokeintensity + smokeyrs + as.factor(exercise) + as.factor(active)
            + wt71, data=data, family=binomial())
summary(model.propensity)
data$ps <- predict(model.propensity, data, type="response")
```


We examine in the figure below the distribution of propensity scores by treatment.

```{r psbytrt, fig.height=5, fig.width=12, dpi=100, echo=FALSE}
# adapt data to format
dat <- data
dat$trt <- dat$qsmk

par(mfrow=c(1, 2))
outps <- histbackback(split(dat$ps, dat$trt), axes=FALSE)
axis(1)
axis(2, las=1, at=1:length(outps$breaks)-0.5,
     labels=round(seq(min(dat$ps), max(dat$ps), length.out=length(outps$breaks)), 2))
mtext(c("Untreated", "Treated"), side=1, at=c(-20, 20), line=3, cex=1.5)
mtext("Propensity score", side=2, at=6, line=3, cex=1.5)
barplot(-outps$left, col="royalblue" , horiz=TRUE, space=0, add=TRUE, axes=FALSE)
barplot(outps$right, col="darkred", horiz=TRUE, space=0, add=TRUE, axes=FALSE)
plot(dat$ps, jitter(dat$trt+0.5), pch=16, cex=0.5, axes=FALSE, type="p",
     col=c("royalblue", "darkred")[dat$trt+1], xlim=c(0,1), ylim=c(0,2), xlab="", ylab="")
axis(1)
mtext(c("Untreated", "Treated"), side=2, at=c(0.5, 1.5), line=3, las=1, adj=0, cex=1.5)
mtext("Propensity score", side=1, at=0.5, line=2.5, cex=1.5)
lines(quantile(dat$ps[dat$trt==0])[c(2,4)], c(0.85, 0.85), col="royalblue")
lines(rep(quantile(dat$ps[dat$trt==0])[3], 2), c(0.8, 0.9), col="royalblue")
lines(quantile(dat$ps[dat$trt==1])[c(2,4)], c(1.15, 1.15), col="darkred")
lines(rep(quantile(dat$ps[dat$trt==1])[3], 2), c(1.1, 1.2), col="darkred")
```


# Estimating treatment effect by stratification


```{r}
dat$psgp <- cut(dat$ps, breaks=quantile(dat$ps, prob=0:5*0.2),
                labels=c("Q1","Q2","Q3","Q4","Q5"), right=FALSE, include.lowest=TRUE)
```

```{r psage, fig.height=5, fig.width=5, dpi=100, echo=FALSE}
par(mar=c(5,5.5,1,1))
plot(0, type="n", axes=FALSE, xlim=c(0.75,6.25), ylim=c(40,70), xlab="", ylab="")
axis(1, at=1:5, labels=paste("Q", 1:5, sep=""))
axis(1, at=6, labels="")
lines(c(5.75,6.25), rep(40,2))
axis(2, las=1, at=4:7*10)
mtext("Age", side=2, at=65, line=4.5, las=1, adj=0, cex=1.5)
mtext("Quintiles of propensity score", side=1, at=3, line=2.5, cex=1.5)
mtext("Overall", side=1, at=6, line=1)
lines(rep(6-0.05, 2), quantile(dat$age[dat$trt==0])[c(2,4)], col=2)
lines(rep(6+0.05, 2), quantile(dat$age[dat$trt==1])[c(2,4)], col=4)
lines(c(6-0.08,6-0.02), rep(quantile(dat$age[dat$trt==0])[c(3)],2), col=2)
lines(c(6+0.02,6+0.08), rep(quantile(dat$age[dat$trt==1])[c(3)],2), col=4)
for(i in 1:5){
  lines(rep(i-0.05, 2), quantile(dat$age[dat$trt==0 & dat$psgp==paste("Q", i, sep="")])[c(2,4)], col="royalblue")
  lines(rep(i+0.05, 2), quantile(dat$age[dat$trt==1 & dat$psgp==paste("Q", i, sep="")])[c(2,4)], col="darkred")
  lines(c(i-0.08,i-0.02), rep(quantile(dat$age[dat$trt==0 & dat$psgp==paste("Q", i, sep="")])[c(3)],2), col="royalblue")
  lines(c(i+0.02,i+0.08), rep(quantile(dat$age[dat$trt==1 & dat$psgp==paste("Q", i, sep="")])[c(3)],2), col="darkred")
}
```


# 

```{r}
dat0 <- dat[dat$trt == 0, ]          ## fetch untreated and treated
dat1 <- dat[dat$trt == 1, ]          ## data separately
match.dat0 <- dat1                   ## placeholder for matching untreated
for (i in 1:nrow(match.dat0)) {      ## for every sought matching untreated
  tmp <- dat0                        ## fetch all untreated
  tmp$psi <- dat1$ps[i]              ## set ps from treated 'i' ind
  tmp$difps <- abs(tmp$psi - tmp$ps) ## calculate diff
  tmp <- tmp[order(tmp$difps), ]     ## order untreated
                                     ## by ps diff w/ 'i' treated
  tmp <- tmp[, 1:(ncol(tmp)-2)]      ## remove psi and difps columns
  match.dat0[i, ] <- tmp[1, ]        ## fetch unreated with
                                     ## smallest ps difference
}
match.dat <- rbind(match.dat0, dat1)
dim(match.dat)
```

```{r  echo=FALSE}
ps_plot_continuous <- function(var, title) {
   plot(match.dat$ps, var, xlab="Propensity score", ylab=title,
       col=c("royalblue", "darkred")[match.dat$trt+1], las=1, cex.lab=1.5)
  lines(lowess(match.dat$ps[match.dat$trt == 0],
               var[match.dat$trt == 0]), lwd=2, col="royalblue")
  lines(lowess(match.dat$ps[match.dat$trt == 1],
               var[match.dat$trt == 1]), lwd=2, col="darkred")
  legend("bottomright", c("Untreated", "Treated"),
       fill=c("royalblue", "darkred"), inset=0.05)
}

ps_plot_categorical <- function(var, breaks, title) {
  gp <- cut(var, breaks=breaks, right=FALSE, include.lowest=TRUE)
  plot(match.dat$ps, gp, xlab="Propensity score", ylab=title,
       col=c("royalblue", "darkred")[match.dat$trt+1], las=1, cex.lab=1.5)
  lines(lowess(match.dat$ps[match.dat$trt == 0],
               gp[match.dat$trt == 0]), lwd=2, col="royalblue")
  lines(lowess(match.dat$ps[match.dat$trt == 1],
               gp[match.dat$trt == 1]), lwd=2, col="darkred")
  legend("bottomright", c("Untreated", "Treated"),
         fill=c("royalblue", "darkred"), inset=0.05)
}
```

```{r fig.height=8, fig.width=8, dpi=100, echo=FALSE}
par(mfrow=c(2,2), oma=c(0,0,2,0))

ps_plot_continuous(match.dat$age, 'Age')
ps_plot_continuous(match.dat$smokeintensity, "Smoking intensity")
ps_plot_categorical(match.dat$education, c(0, 1, 2, 4, 5), "Education Level")
ps_plot_categorical(match.dat$sex, c(0, 1, 2), "Sex")
mtext("Propensity score", line=0, side=3, outer=TRUE, cex=2)
```



We can estimate the average treatment effect as difference in means in the matched data.

```{r}
ATE.mt <- mean(match.dat$death[match.dat$trt == 1]) -
             mean(match.dat$death[match.dat$trt == 0])
ATE.mt
mt.d0 <- sum(match.dat$death[match.dat$trt == 0])
mt.d1 <- sum(match.dat$death[match.dat$trt == 1])
mt.n0 <- sum(match.dat$trt == 0)
mt.n1 <- sum(match.dat$trt == 1)
ATE.OR.mt <- (mt.d1 / (mt.n1-mt.d1)) / (mt.d0 / (mt.n0 - mt.d0))
mt.logOR.se <- sqrt(1/mt.d1 + 1/(mt.n1-mt.d1) + 1/mt.d0 + 1/(mt.n0-mt.d0))
ATE.OR.mt.CI <- c(exp(log(ATE.OR.mt) - 1.96*mt.logOR.se),
                  exp(log(ATE.OR.mt) + 1.96*mt.logOR.se))
print(ATE.OR.mt)
print(ATE.OR.mt.CI)
```

##Â Instrumental Variable

Instrumental variable (IV) estimation is important in causal inference because it provides a method to address endogeneity. 

Endogeneity can lead to biased and inconsistent estimates of the regression coefficients. If the explanatory variables are correlated with the error term, it suggests that there are unobserved factors influencing both the explanatory variables and the dependent variable. This violates the assumption of exogeneity, leading to biased estimates.

IV also helps addressing confounding factors that may bias causal inference. By isolating the variation in the endogenous variable that is independent of other covariates, IV estimation allows researchers to control for confounding and obtain more accurate estimates of causal effects.

Confounding occurs when an observed association between an explanatory variable and the dependent variable is distorted or confounded by the presence of a third variable (confounder) that is associated with both the explanatory variable and the dependent variable. Confounding should be avoided as it can lead to incorrect conclusions about the causal relationship between variables. Controlling for confounding variables is essential to obtain unbiased estimates of causal effects.


paste(names(dat), collapse=' + ')

dat$diabetes

```{r}
# Formulas:
# y ~ x1 + x2 | x1 + z1 + z2, 
# x1:exogenous; x2:endogenous
# x1, z1, z2 are instrumental variables

mle_formula <- 
    wt82_71 ~ 
    # Demographic
    sex + age + race + 
    # Smoking
    + smokeintensity + smokeyrs +
    # Health
    + wt71 + alcoholhowmuch + diabetes

# BE CAREFUL: Warning: more regressors than instruments!!
iv_formula <- 
    wt82_71 ~ 
    # Demographic
    sex + age + race + 
    # Smoking
    + smokeintensity + smokeyrs + 
    # Health
    + wt71 + alcoholhowmuch + diabetes |
    hightax82 + price71 + price82 + tax71 + tax82 + price71_82 + tax71_82 + income

# MLE
mle.fit <- lm(mle_formula, data = dat)
summary(mle.fit)

# Instrumental variable estimation
iv.fit <- ivreg::ivreg(iv_formula, data = dat)
summary(iv.fit)

# Summaries
models <- list(MLE = mle.fit, IV = iv.fit)
#car::compareCoefs(mle.fit, iv.fit)
modelsummary::modelplot(models, coef_omit = 'Intercept|experience')
```

```{r}
dat$highprice <- ifelse(dat$price82>=1.5, 1, 0)
t.test(wt82_71 ~ highprice, data=dat)
```

dat$wt82_71

## Treatment confidence intervals

paste(names(dat), collapse=' + ')

```{r}
# Ouput matrix
res <- data.frame(
  estimate = NA,
  low_int = NA,
  upp_int = NA,
  pval_or_pip = NA)

# OLS ##########################################################################
if (nrow(X) > ncol(X)) {
  # This can only be done in the small dataset
  f <- as.formula(wt82_71 ~ qsmk + yrdth + modth + dadth + sbp + dbp + sex + age + race + income + marital + school + education + ht + wt71 + birthplace + smokeintensity + smkintensity82_71 + smokeyrs + asthma + bronch + tb + hf + hbp + pepticulcer + colitis + hepatitis + chroniccough + hayfever + diabetes + polio + tumor + nervousbreak + alcoholpy + alcoholfreq + alcoholtype + alcoholhowmuch + pica + headache + otherpain + weakheart + allergies + nerves + lackpep + hbpmed + boweltrouble + infection + active + exercise + birthcontrol + pregnancies + cholesterol + hightax82 + price71 + price82 + tax71 + tax82 + price71_82 + tax71_82 + id + censored + older)
  
  mle <- lm(f, data = dat)
  b.mle <- summary(mle)[['coefficients']]
  b.mle <- cbind(b.mle[, 1], confint(mle), b.mle[, 4])
  colnames(b.mle)[1] <- 'Estimate'
  colnames(b.mle)[4] <- 'p-value'
  round(head(b.mle, 2), 4)
  #             Estimate   2.5 % 97.5 % p-value
  # (Intercept)   0.0000 -0.0380 0.0379  0.9995
  # d             0.1059 -0.0663 0.2780  0.2263

  # Add to output
  res[1, ] <- b.mle['qsmk', ]
}
rownames(res)[nrow(res)] <- 'mle'
res
```

```{r}
# LASSO + BIC ##################################################################
lasso.fit <- lasso.bic(dat$wt82_71, )
round(head(lasso.fit[['coef']], 2), 3)
# Intercept         d 
#     0.000     0.039 

# Add to output
res <- rbind.data.frame(res, c(lasso.fit[['coef']]['d'], NA, NA, NA))
rownames(res)[nrow(res)] <- 'lasso_bic'

res
```


```{r}
summary(nhefs$ps[nhefs$qsmk==0])
summary(nhefs$ps[nhefs$qsmk==1])

# # plotting the estimated propensity score
# install.packages("ggplot2") # install packages if necessary
# install.packages("dplyr")
library("ggplot2")
library("dplyr")
ggplot(nhefs, aes(x = ps, fill = qsmk)) + geom_density(alpha = 0.2) +
  xlab('Probability of Quitting Smoking During Follow-up') +
  ggtitle('Propensity Score Distribution by Treatment Group') +
  scale_fill_discrete('') +
  theme(legend.position = 'bottom', legend.direction = 'vertical')

# alternative plot with histograms
nhefs <- nhefs %>% mutate(qsmklabel = ifelse(qsmk == 1,
                       yes = 'Quit Smoking 1971-1982',
                       no = 'Did Not Quit Smoking 1971-1982'))
ggplot(nhefs, aes(x = ps, fill = as.factor(qsmk), color = as.factor(qsmk))) +
  geom_histogram(alpha = 0.3, position = 'identity', bins=15) +
  facet_grid(as.factor(qsmk) ~ .) +
  xlab('Probability of Quitting Smoking During Follow-up') +
  ggtitle('Propensity Score Distribution by Treatment Group') +
  scale_fill_discrete('') +
  scale_color_discrete('') +
  theme(legend.position = 'bottom', legend.direction = 'vertical')

# attempt to reproduce plot from the book
nhefs %>%
  mutate(ps.grp = round(ps/0.05) * 0.05) %>%
  group_by(qsmk, ps.grp) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(n2 = ifelse(qsmk == 0, yes = n, no =  -1*n)) %>%
  ggplot(aes(x = ps.grp, y = n2, fill = as.factor(qsmk))) +
  geom_bar(stat = 'identity', position = 'identity') +
  geom_text(aes(label = n, x = ps.grp, y = n2 + ifelse(qsmk == 0, 8, -8))) +
  xlab('Probability of Quitting Smoking During Follow-up') +
  ylab('N') +
  ggtitle('Propensity Score Distribution by Treatment Group') +
  scale_fill_discrete('') +
  scale_x_continuous(breaks = seq(0, 1, 0.05)) +
  theme(legend.position = 'bottom', legend.direction = 'vertical',
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())
```
